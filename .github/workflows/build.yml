on: [push, pull_request]

jobs:
    tests:
        runs-on: ubuntu-24.04
        name: Build
        steps:
            - name: "Checkout"
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: "Install dependencies"
              run: |
                  sudo add-apt-repository ppa:puni070/gcc-noble -y
                  sudo apt -y update
                  sudo apt -y install gcc-15 libgtk-3-dev libx11-dev libjansson-dev libluajit-5.1-dev
                  sudo pip3 install meson
                  sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-15 150
                  sudo update-alternatives --set gcc /usr/bin/gcc-15

            - name: "Configure"
              run: meson setup build -Dbuildtype=release

            - name: "Build"
              run: meson compile -C build

            - name: Set Build number
              shell: bash
              run: echo "build_number=$(git rev-list HEAD --count)" >> $GITHUB_ENV

            - name: Compute git short sha
              shell: bash
              run: echo "git_short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

            - name: "Bundle extra files"
              run: |
                  mkdir release
                  cp -r assets release/
                  cp -r build/libresplit release/
                  cp README.md release/
                  cp LICENSE release/

            - name: "Upload artifacts"
              uses: actions/upload-artifact@v4
              with:
                  name: LibreSplit-${{ env.build_number }}-${{ env.git_short_sha }}
                  path: release/
